# 多线程

这个专题真的好神圣，因为多线程在我心中就是一座永远不能登高的高峰。因为从来没有弄明白过，sad。


## 进程和线程

在正式学习之前，我们需要补一下操作系统的相关知识。
首先明确"CPU"、“多核处理器”、"多处理器"这些名词的关系。

首先"CPU"，中央处理器，是一块超大规模的集成电路，是一条计算机的运算核心和控制核心。通常家用电脑就一个CPU，一些服务器和图形工作站都有2个、4个或者更多的CPU，大型服务器或者超级电脑有多少个都行。

“多核”指的是什么呢?多核处理器是指在一枚处理器中继承两个或者多个完整的计算引擎（内核）。在运算效果上等同于多个“单核CPU”。”多核处理器“和“多处理器”是完全不同的概念。至于单个“多核处理器”和多个“单核处理器”之间的区别和优劣，网上讨论很多了。不再赘述了。

> 看知乎上有个形象的总结：简单来说就是一家子人干活和几家人干活的区别，假设人数一样，一家人开个门就能商量，几家人要过街才能商量。

> 多CPU的方式称为分布式计算！

进程的概念有一个背景：多道程序设计技术。

在这个技术引进之前，多个程序串行执行。只存在一个程序计数器（PC, program counter）,一个程序执行完毕之后，才会执行下一个程序。

而多道程序设计技术是在计算机内存中同时存放几道相互独立的程序，使它们在管理程序控制之下，相互穿插的运行。 两个或两个以上程序在计算机系统中同处于开始到结束之间的状态。这就称为多道程序设计。

注意这里的描述“相互穿插的运行”，这是什么意思？一个CPU在同一时间只能处理一项任务，那么如何选择处理哪项任务呢，这就是所谓的任务调度。大部分操作系统(如Windows、Linux)的任务调度是采用时间片轮转的抢占式调度方式，也就是说一个任务执行一小段时间后强制暂停去执行下一个任务，每个任务轮流执行。任务执行的一小段时间叫做时间片，任务正在执行时的状态叫运行状态，任务执行一段时间后强制暂停去执行下一个任务，被暂停的任务就处于就绪状态等待下一个属于它的时间片的到来。这样每个任务都能得到执行。由于CPU的效率非常高，所以每个任务没有隔多久就又被执行了，从我们的感官来看，就好像每个任务都没有被耽误，多个任务都在**并发(concurrent)**执行。

这里又有一个概念：**并发(concurrent)**，和它经常放在一起比较的另外一个词是：**并行(parallel)**。两者有什么区别和联系呢？

Erlang 之父 Joe Armstrong用下面这张图解释了concurrent和parallel的区别：

![concurrent&paralle](http://ovn0i3kdg.bkt.clouddn.com/concurrent&parallel.jpg?imageView/2/w/400)


可以看到，两队人交替使用同一个咖啡机，是并发（concurrent）；两队人同时使用两个咖啡机，是并行（parallel）；一对人使用一台咖啡机，是串行（serialization）。

> 并行：多个cpu实例或者多台机器同时执行一段处理逻辑，是真正的同时。
> 并发：通过cpu调度算法，让用户看上去同时执行，实际上从cpu操作层面不是真正的同时。并发往往在场景中有公用的资源，那么针对这个公用的资源往往产生瓶颈，我们会用TPS或者QPS来反应这个系统的处理能力。

话题扯远了，回到正题。既然多道程序设计允许多个程序同时进入内存并发并行，那么就要每个程序都分配程序计数器了，那么如何描述、刻画这样执行的程序呢？因此引入了“进程”。下面进程的一种定义：

> 进程是具有独立功能的程序关于某个**数据集合**上的一次**运行活动**，是系统进行资源分配和调度（若不支持线程机制，进程的系统调度的单位。否则，线程是系统调度的单位）的独立单位。

注意定义里面的几个关键词，"运行活动"说明进程是程序的一次执行过程，如果程序要执行两次甚至多次，那么需要两次甚至多次进程。“数据集合”是说系统资源（如内存、文件）以进程为单位分配，操作系统为每个进程分配了独立的地址空间，通过“调度”把控制权交给进程。

有了进程的概念，那么为什么还要引入线程呢？有这些考虑：
1. 应用的需要。比如打开一个浏览器，我想一边浏览网页，一边下载文件，一边播放音乐。如果一个浏览器是一个进程，那么这样的需求需要线程机制。
2. 开销的考虑。在进程内创建、终止线程比创建、终止进程要快。同一进程内的线程间切换比进程间的切换要快,尤其是用户级线程间的切换。线程之间相互通信无须通过内核（同一进程内的线程共享内存和文件）
3. 性能的考虑。多个线程中，任务功能不同（有的负责计算，有的负责I/O）,如果有多个处理器，一个进程就可以有很多的任务同时在执行。

线程有以下特点：
1. 有标识符ID
2. 有状态及状态转换，所以需要提供一些状态转换操作
3. 不运行时需要保存上下文环境，所以需要程序计数器等寄存器
4. 有自己的栈和栈指针
5. 共享所在进程的地址空间和其它资源

> 线程和进程更通俗易懂的解释可以参考 https://www.zhihu.com/question/25532384，讲的很明白易懂了。

线程和进程之间的区别：

| 比较项     | 进程     | 线程|
| :------------- | :------------- |: --- |
| 定义| 程序在某个数据集合上的一次运行活动     | 线程是进程中的一个执行路径。|
|角色   |  系统资源分配的单位 | CPU调度的单位  |
|资源共享   |进程之间不能共享资源。一个进程由内存空间(代码、数据、进程空间、打开的文件)和一个或多个线程组成   | 线程共享所在进程的地址空间和其它资源。一个标准的线程由线程ID、当前指令指针(PC)、寄存器和堆栈  |
|独立性   |  有自己独立的地址空间 |  没有独立空间，线程必须依赖于进程而存在。 |
|开销   |   切换的开销较大|相对较小   |



## 多线程和多核
前面提到的"同一时间只有一个任务在执行"，这句话在当下看来是不对的，至少是不全面的。这句话说的是单个单核处理器的情况，但是现在大都是多核处理器，这时候会怎么进行进程和线程的处理呢？

**多核(心)处理器**是指在一个处理器上集成多个运算核心从而提高计算能力，也就是有多个真正并行计算的处理核心，每一个处理核心对应一个**内核线程**。

**内核线程（Kernel Thread， KLT）**就是直接由操作系统内核支持的线程，这种线程由内核来完成线程切换，内核通过操作调度器对线程进行调度，并负责将线程的任务映射到各个处理器上。一般一个处理核心对应一个内核线程，比如单核处理器对应一个内核线程，双核处理器对应两个内核线程，四核处理器对应四个内核线程。

现在的电脑一般是双核四线程、四核八线程，是采用**超线程技术**将一个**物理处理核心**模拟成**两个逻辑处理核心**，对应**两个内核线程**，所以在操作系统中看到的CPU数量是实际物理CPU数量的两倍，如你的电脑是双核四线程，打开“任务管理器性能”可以看到4个CPU的监视器，四核八线程可以看到8个CPU的监视器。

那么，四核八线程处理器是不是能让八线程并行呢？
不是！CPU中的线程与操作系统中的线程不是一个概念，CPU中的操作是以时序为准的，它类似一个流水线操作，8线程指同时有8条指令被执行，但这所谓的执行在时序上是有差别的。由于同时处理多条指令从而提高了CPU的处理速度。但对PC系统而言它的处理还是一个分时系统，每次只能完成一个任务片段。而"四核八线程"是指四个物理核心，八个逻辑核心，有几核心就有多少个真实线程，多出来的都是假的。

## 线程的生命周期
当线程的数量小于处理器的数量时，线程的并发是真正的并发，不同的线程运行在不同的处理器上。但当线程的数量大于处理器的数量时，线程的并发会受到一些阻碍，此时并不是真正的并发，因为此时至少有一个处理器会运行多个线程。那么这些线程中同一时刻只能有一个是被执行的，其他的都在等待，这就有了“线程的生命周期”一说。

下面是一张完整的线程的生命周期图，这张图给我背下来！闭着眼睛都能画出来的程度！

![thread_life_cycle](http://ovn0i3kdg.bkt.clouddn.com/thread_lifecycle.jpeg)

线程一般有5种状态
1. `新建`：就是新建了一个线程对象。
2. `就绪`：即可运行状态，就是调用start()方法后，线程将进入一个线程池，等待系统分配资源，（注意不是说用start()方法后，线程就被执行的，他得等待获得资源），一旦得到CPU资源就能运行
3. `运行`：就是系统给分配了资源（有的教材认为资源就是CPU的使用权），程序开始执行
4. `阻塞`：由于某种原因，程序执行到某种程度时，放弃了资源的使用权，暂时停止运行。满足相应条件后，又变成可运行状态，这个由分为几种情况：
  1. `等待阻塞`：运行的线程执行了wait()方法；
  2. `同步阻塞`：运行的线程在获取对象的同步锁时，若该同步锁被别的线程占用；
  3. `其他阻塞`：运行的线程执行sleep()或join()方法，或者发出了I/O请求时，JVM会把该线程置为阻塞状态。
5. `结束`：也叫死亡状态，就是程序执行完成了，或发生异常退出run()方法了。


参考
* [多核 CPU 和多个 CPU 有何区别？](https://www.zhihu.com/question/20998226)
* [多核与多个CPU啥区别](http://blog.csdn.net/hellochenlu/article/details/51507989)
* [编程思想之多线程与多进程(1)——以操作系统的角度述说线程与进程](http://blog.csdn.net/luoweifu/article/details/46595285)
* [多个处理器和多核处理器的区别](http://blog.csdn.net/kevin_yzlong/article/details/70196168)
* [进程与线程的一个简单解释](http://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html)
* [线程和进程的区别是什么？](https://www.zhihu.com/question/25532384)
* [我是一个线程](http://kb.cnblogs.com/page/542462/)
* [深入理解进程和线程](http://www.cnblogs.com/tiankong101/p/4229584.html)
* [Java中Wait、Sleep和Yield方法的区别](http://www.jianshu.com/p/25e959037eed)
* [Java线程状态转换](https://www.toutiao.com/i6368772681411592706/)
* [一张图让你看懂JAVA线程间的状态转换](https://my.oschina.net/mingdongcheng/blog/139263)
*
